<script>
    $('#exampleModal').modal('show');

</script>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <div class="col-md-12 modal-title text-center" id="exampleModalLabel"><b>ທ່ານລໍຖ້າ.!</b>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="col-12 border" id="bg">
                    <div id="container">
                        <img id="hd" src="/static/default/loading.gif" class="img-fluid img-rounded"/>
                        <canvas class="center-block img-fluid" id="canvasOutput"></canvas>

                    </div>
                    <div class="invisible" style="display: none">
                        <video id="video" class="hidden">Your browser does not support the video tag.</video>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="text-center" id="bt_show" style="display: none">
                    <button class="btn btn-outline-success" onClick="take_snapshot()">
                        <span class="fa fa-images"></span> ປະມວນຮັບຮູ້ຂໍ້ມູນຕົວຕົນ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!--<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://threejs.org/examples/js/libs/stats.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.min.js"></script>-->
<script type="text/javascript" src="{{ url_for('static', filename='js/adapter-latest.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/stats.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/dat.gui.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/webcam.js') }}"></script>
<script>
    var videoWidth, videoHeight;

    // whether streaming video from the camera.
    var streaming = false;

    var video = document.getElementById('video');
    var canvasOutput = document.getElementById('canvasOutput');
    var canvasOutputCtx = canvasOutput.getContext('2d');
    var stream = null;

    function startCamera() {
        if (streaming) return;
        navigator.mediaDevices.getUserMedia({video: true, audio: false})
            .then(function (s) {
                console.log(s)
                stream = s;
                video.srcObject = s;
                video.play();
            })
            .catch(function (err) {
                console.log("An error occured! " + err);
            });
        video.addEventListener("canplay", function (ev) {
            if (!streaming) {
                videoWidth = video.videoWidth;
                videoHeight = video.videoHeight;
                video.setAttribute("width", videoWidth);
                video.setAttribute("height", videoHeight);
                canvasOutput.width = videoWidth;
                canvasOutput.height = videoHeight;
                streaming = true;
            }
            startVideoProcessing();
        }, false);
    }

    var faceClassifier = null;

    var src = null;
    var dstC1 = null;
    var dstC3 = null;
    var dstC4 = null;

    var canvasInput = null;
    var canvasInputCtx = null;

    var canvasBuffer = null;
    var canvasBufferCtx = null;
    var number_save = 0;
    var saved = true;

    function startVideoProcessing() {
        if (!streaming) {
            console.warn("Please startup your webcam");
            return;
        }
        stopVideoProcessing();
        canvasInput = document.createElement('canvas');
        canvasInput.width = videoWidth;
        canvasInput.height = videoHeight;
        canvasInputCtx = canvasInput.getContext('2d');

        canvasBuffer = document.createElement('canvas');
        canvasBuffer.width = videoWidth;
        canvasBuffer.height = videoHeight;
        canvasBufferCtx = canvasBuffer.getContext('2d');

        srcMat = new cv.Mat(videoHeight, videoWidth, cv.CV_8UC4);
        grayMat = new cv.Mat(videoHeight, videoWidth, cv.CV_8UC1);

        faceClassifier = new cv.CascadeClassifier();
        faceClassifier.load('haarcascade_frontalface_default.xml');

        requestAnimationFrame(processVideo);
    }

    var capture_img = false;

    function take_snapshot() {
        capture_img = true;
        processVideo()
    }

    function loadImage() {
        document.getElementById('hd').style.display = 'none';
        document.getElementById('bt_show').style.display = 'block';
    }

    function processVideo() {
        loadImage()
        stats.begin();
        canvasInputCtx.drawImage(video, 0, 0, videoWidth, videoHeight);
        var imageData = canvasInputCtx.getImageData(0, 0, videoWidth, videoHeight);
        srcMat.data.set(imageData.data);

        cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);
        var faces = [];
        var size;
        var faceVect = new cv.RectVector();
        var faceMat = new cv.Mat();
        cv.pyrDown(grayMat, faceMat);
        cv.pyrDown(faceMat, faceMat);
        size = faceMat.size();
        faceClassifier.detectMultiScale(faceMat, faceVect);
        for (var i = 0; i < faceVect.size(); i++) {
            var face = faceVect.get(i);
            var rect = new cv.Rect(face.x, face.y, face.width, face.height);
            faces.push(rect);

        }
        faceMat.delete();
        faceVect.delete();
        canvasOutputCtx.drawImage(canvasInput, 0, 0, videoWidth, videoHeight);
        if (capture_img == true) {
            capture_img = false
            Webcam.upload(canvasOutput.toDataURL(), '/capturepridict', function (code, text) {
                stopCamera()
                stopVideoProcessing()
                $.ajax({
                    url: '/capturepridict',
                    dataType: "json",
                    beforeSend: function () {
                        $("#result").html('<img src="static/default/loading.gif" class="rounded mx-auto d-block img-thumbnail img-fluid">')
                    },
                    success: function (text) {
                        $('body').removeClass('modal-open');
                        $('.modal-backdrop.show').css('opacity', '0');
                        $('.modal-backdrop').css('z-index', '-1');
                        $("#result").html(text.result)
                    },
                });
                return false;
            });
        }
        drawResults(canvasOutputCtx, faces, 'red', size);
        stats.end();
        requestAnimationFrame(processVideo);
    }

    function drawResults(ctx, results, color, size) {
        for (var i = 0; i < results.length; ++i) {
            var rect = results[i];
            var xRatio = videoWidth / size.width;
            var yRatio = videoHeight / size.height;
            ctx.lineWidth = 3;
            ctx.strokeStyle = color;
            ctx.strokeRect(rect.x * xRatio, rect.y * yRatio, rect.width * xRatio, rect.height * yRatio);
        }
    }

    function stopVideoProcessing() {
        if (src != null && !src.isDeleted()) src.delete();
        if (dstC1 != null && !dstC1.isDeleted()) dstC1.delete();
        if (dstC3 != null && !dstC3.isDeleted()) dstC3.delete();
        if (dstC4 != null && !dstC4.isDeleted()) dstC4.delete();
    }

    function stopCamera() {
        if (!streaming) return;

        video.pause();
        video.srcObject = null;
        stream.getVideoTracks()[0].stop();
        streaming = false;
    }

    function initUI() {
        stats = new Stats();
        stats.showPanel(0);
        document.getElementById('container').appendChild(stats.dom);
    }

    function opencvIsReady() {
        console.log('OpenCV.js is ready');
        initUI();
        startCamera();
    }

    var Module = {
        //wasmBinaryFile: 'https://huningxin.github.io/opencv.js/build/wasm/opencv_js.wasm',
        wasmBinaryFile: "{{ url_for('static', filename='js/opencv_js.wasm') }}",
        preRun: [function () {
            // Module.FS_createPreloadedFile('/', 'haarcascade_eye.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_eye.xml', true, false);
            Module.FS_createPreloadedFile('/', 'haarcascade_frontalface_default.xml', "{{ url_for('static', filename='js/haarcascade_frontalface_default.xml') }}", true, false);
            //Module.FS_createPreloadedFile('/', 'haarcascade_profileface.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_profileface.xml', true, false);
        }],
        _main: function () {
            opencvIsReady();
        }
    };
</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/opencv.js') }}"></script>
<!--<script async src="https://huningxin.github.io/opencv.js/build/wasm/opencv.js"></script>-->